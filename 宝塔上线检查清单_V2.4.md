# 宝塔面板上线检查清单 V2.4

## 🔍 上线前检查确认

### ✅ 1. Python主程序适配确认
- [x] **main_v2_4_final.py** 已适配生产环境路径
- [x] 使用 `Path(__file__).resolve().parent` 获取绝对路径
- [x] 静态文件和模板路径使用绝对路径配置
- [x] 支持 `.env` 和 `.env.production` 环境文件

### ✅ 2. 依赖包配置确认
- [x] **requirements.txt** 包含 `python-multipart>=0.0.5`
- [x] 所有必要依赖包已列出
- [x] 版本号兼容生产环境

### ✅ 3. WordPress插件配置确认
- [x] **register_activation_hook** 已正确配置
- [x] 日志表创建逻辑已实现
- [x] **已删除所有调试代码** `wp_set_current_user(1)`
- [x] 生产环境权限验证已启用

### ✅ 4. 宝塔环境专用文件
- [x] **start_baota.py** - 宝塔专用启动脚本
- [x] 自动检查Python版本和依赖
- [x] 路径适配和环境检测

## 🚀 宝塔面板部署步骤

### 第一步：上传文件
```bash
# 将以下文件上传到宝塔网站目录
main_v2_4_final.py          # 主程序文件
start_baota.py              # 宝塔启动脚本
requirements.txt            # 依赖包列表
.env.production             # 生产环境配置
static/                     # 静态文件目录
templates/                  # 模板文件目录
wp-adv-manager/             # WordPress插件目录
```

### 第二步：配置Python环境
```bash
# 在宝塔面板中设置Python版本
Python版本: 3.8+ (推荐3.9)
项目路径: /www/wwwroot/your-domain/
启动文件: start_baota.py
```

### 第三步：安装依赖包
```bash
# 在宝塔终端中执行
cd /www/wwwroot/your-domain/
pip install -r requirements.txt
```

### 第四步：配置环境变量
编辑 `.env.production` 文件：
```bash
# WordPress连接配置
WP_DOMAIN=your-wordpress-domain.com
WP_USERNAME=your-wp-username
WP_APP_PASSWORD=your-app-password

# 百度AI配置
BAIDU_API_KEY=your-baidu-api-key
BAIDU_SECRET_KEY=your-baidu-secret-key

# 系统配置
TEST_MODE=false
AI_REVIEW_ENABLED=true
PORT=8001
HOST=0.0.0.0

# 安全配置
SESSION_SECRET_KEY=your-super-secret-key-here
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password
CONTRACTOR_USERNAME=contractor
CONTRACTOR_PASSWORD=contractor-password
```

### 第五步：WordPress插件安装
1. 将 `wp-adv-manager` 目录上传到WordPress插件目录
2. 在WordPress后台激活插件
3. 插件会自动创建 `adv_publish_log` 日志表

### 第六步：启动服务
```bash
# 方式1：使用宝塔启动脚本
python start_baota.py

# 方式2：直接启动
python main_v2_4_final.py

# 方式3：使用uvicorn
uvicorn main_v2_4_final:app --host 0.0.0.0 --port 8001
```

## 🔧 宝塔面板配置

### 1. 网站设置
- **运行目录**: 项目根目录
- **Python版本**: 3.8+
- **启动方式**: Python项目
- **启动文件**: start_baota.py

### 2. 反向代理设置
```nginx
location / {
    proxy_pass http://127.0.0.1:8001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 3. SSL证书配置
- 在宝塔面板中申请Let's Encrypt证书
- 或上传自有SSL证书

### 4. 防火墙设置
- 开放8001端口（如果需要直接访问）
- 或只开放80/443端口（通过反向代理访问）

## 🧪 功能测试清单

### 基础功能测试
- [ ] 网站可正常访问
- [ ] 登录功能正常
- [ ] 静态文件加载正常
- [ ] 模板渲染正常

### 核心功能测试
- [ ] 文章发布功能
- [ ] AI审核功能
- [ ] WordPress连接正常
- [ ] 发稿统计功能
- [ ] 审核日志记录

### WordPress插件测试
- [ ] 插件激活成功
- [ ] 日志表创建成功
- [ ] 审核功能正常
- [ ] 统计页面显示正常

## 🔒 安全检查清单

### 代码安全
- [x] 已删除所有 `wp_set_current_user(1)` 调试代码
- [x] 生产环境权限验证已启用
- [x] 敏感信息使用环境变量

### 服务器安全
- [ ] 默认密码已修改
- [ ] 防火墙已配置
- [ ] SSL证书已安装
- [ ] 文件权限已设置

### 数据安全
- [ ] 数据库备份已配置
- [ ] 日志文件权限已设置
- [ ] 敏感文件访问已限制

## 📊 性能优化

### 宝塔面板优化
- 启用Gzip压缩
- 配置静态文件缓存
- 设置合适的worker进程数

### Python应用优化
```bash
# 多进程启动（推荐）
uvicorn main_v2_4_final:app --host 0.0.0.0 --port 8001 --workers 4

# 或使用gunicorn
gunicorn main_v2_4_final:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8001
```

## 🆘 常见问题解决

### 1. 路径问题
```python
# 如果遇到路径问题，检查BASE_DIR设置
BASE_DIR = Path(__file__).resolve().parent
```

### 2. 依赖包问题
```bash
# 升级pip
pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3. 权限问题
```bash
# 设置正确的文件权限
chmod +x start_baota.py
chown -R www:www /www/wwwroot/your-domain/
```

### 4. 端口占用
```bash
# 检查端口占用
netstat -tlnp | grep 8001

# 修改端口配置
export PORT=8002
```

## ✅ 上线完成确认

部署完成后，请确认以下功能正常：

1. **Web界面访问** - http://your-domain.com
2. **用户登录** - 管理员和外包人员登录
3. **文章发布** - 发布测试文章
4. **AI审核** - 审核功能开关
5. **WordPress集成** - 文章同步到WordPress
6. **发稿统计** - 统计数据显示正常
7. **审核日志** - 日志记录功能

## 🎉 上线成功

恭喜！您的WordPress软文发布系统已成功部署到宝塔面板。

**访问地址**: http://your-domain.com  
**管理后台**: http://your-domain.com/admin  
**WordPress插件**: 软文管理 → 发稿统计

系统现在可以稳定运行，支持：
- 永久发稿统计（不受文章删除影响）
- AI智能审核
- 多用户权限管理
- 完整的操作日志记录