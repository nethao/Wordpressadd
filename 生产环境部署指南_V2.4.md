# WordPress软文发布系统 - 生产环境部署指南 V2.4

## 🐍 Python版本要求

### 最低版本要求
- **Python 3.7+** （推荐 Python 3.8 或更高版本）
- 支持 asyncio 异步编程
- 支持 typing 类型注解

### 推荐版本
- **Python 3.8** - 稳定性好，兼容性强
- **Python 3.9** - 性能优化，新特性支持
- **Python 3.10+** - 最新特性，最佳性能

### 版本检查命令
```bash
# 检查Python版本
python --version
python3 --version

# 检查是否支持asyncio
python -c "import asyncio; print('✅ asyncio支持正常')"
```

## 📦 系统依赖安装

### 1. 核心依赖包
```bash
# 安装所有依赖
pip install -r requirements.txt

# 或者手动安装核心包
pip install fastapi>=0.100.0
pip install uvicorn[standard]>=0.20.0
pip install aiohttp>=3.8.0
pip install jinja2>=3.0.0
pip install python-dotenv>=1.0.0
pip install pydantic>=2.0.0
```

### 2. 生产环境额外依赖
```bash
# 性能监控
pip install psutil>=5.9.0

# 安全加密
pip install cryptography>=41.0.0

# 进程管理（推荐）
pip install gunicorn>=20.1.0
```

## 🔧 环境配置

### 1. 环境变量配置
复制并配置环境文件：
```bash
# 复制模板文件
cp .env.template .env.production

# 编辑生产环境配置
nano .env.production
```

### 2. 生产环境配置示例
```bash
# WordPress连接配置
WP_DOMAIN=your-wordpress-domain.com
WP_USERNAME=your-wp-username
WP_APP_PASSWORD=your-app-password

# 百度AI配置
BAIDU_API_KEY=your-baidu-api-key
BAIDU_SECRET_KEY=your-baidu-secret-key

# 系统配置
TEST_MODE=false
AI_REVIEW_ENABLED=true
PORT=8001
HOST=0.0.0.0

# 安全配置
SESSION_SECRET_KEY=your-super-secret-key-here
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password
CONTRACTOR_USERNAME=contractor
CONTRACTOR_PASSWORD=contractor-password
```

## 🚀 部署方式

### 方式1: 直接运行（开发/测试）
```bash
# 使用启动脚本
python start_v2_4.py

# 或直接运行
python main_v2_4_final.py
```

### 方式2: Uvicorn生产部署
```bash
# 单进程运行
uvicorn main_v2_4_final:app --host 0.0.0.0 --port 8001

# 多进程运行（推荐）
uvicorn main_v2_4_final:app --host 0.0.0.0 --port 8001 --workers 4
```

### 方式3: Gunicorn + Uvicorn（高性能）
```bash
# 安装gunicorn
pip install gunicorn

# 运行命令
gunicorn main_v2_4_final:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8001
```

### 方式4: Docker部署
创建 `Dockerfile`：
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 复制依赖文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8001

# 启动命令
CMD ["uvicorn", "main_v2_4_final:app", "--host", "0.0.0.0", "--port", "8001"]
```

构建和运行：
```bash
# 构建镜像
docker build -t wordpress-publisher:v2.4 .

# 运行容器
docker run -d -p 8001:8001 --env-file .env.production wordpress-publisher:v2.4
```

## 🔒 安全配置

### 1. 防火墙设置
```bash
# 只允许必要端口
ufw allow 8001/tcp
ufw enable
```

### 2. 反向代理（Nginx推荐）
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. SSL证书配置
```bash
# 使用Let's Encrypt
certbot --nginx -d your-domain.com
```

## 📊 性能优化

### 1. 系统资源要求
- **最小配置**: 1核CPU, 512MB内存
- **推荐配置**: 2核CPU, 1GB内存
- **高负载配置**: 4核CPU, 2GB内存

### 2. 进程数量配置
```bash
# 根据CPU核心数设置worker数量
# 推荐公式: workers = (CPU核心数 × 2) + 1

# 1核CPU
--workers 3

# 2核CPU  
--workers 5

# 4核CPU
--workers 9
```

### 3. 内存优化
```bash
# 设置Python内存限制
export PYTHONMALLOC=malloc

# 垃圾回收优化
export PYTHONOPTIMIZE=1
```

## 🔍 监控和日志

### 1. 日志配置
```python
# 在生产环境中启用详细日志
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/wordpress-publisher.log'),
        logging.StreamHandler()
    ]
)
```

### 2. 健康检查
```bash
# 检查服务状态
curl http://localhost:8001/health

# 检查API状态
curl http://localhost:8001/api/status
```

### 3. 进程监控
```bash
# 使用systemd管理服务
sudo nano /etc/systemd/system/wordpress-publisher.service
```

systemd服务文件示例：
```ini
[Unit]
Description=WordPress Publisher Service
After=network.target

[Service]
Type=exec
User=www-data
Group=www-data
WorkingDirectory=/path/to/your/app
Environment=PATH=/path/to/your/venv/bin
ExecStart=/path/to/your/venv/bin/uvicorn main_v2_4_final:app --host 0.0.0.0 --port 8001
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable wordpress-publisher
sudo systemctl start wordpress-publisher
sudo systemctl status wordpress-publisher
```

## 🧪 部署前测试

### 1. 功能测试
```bash
# 运行测试脚本
python test_v2_4.py

# 简单功能测试
python test_v2_4_simple.py
```

### 2. 性能测试
```bash
# 安装测试工具
pip install locust

# 运行压力测试
locust -f performance_test.py --host=http://localhost:8001
```

### 3. 安全审计
```bash
# 运行安全检查
python security_audit_v2_4.py
```

## 📋 部署检查清单

### 部署前检查
- [ ] Python版本 >= 3.7
- [ ] 所有依赖包已安装
- [ ] 环境变量已配置
- [ ] WordPress连接测试通过
- [ ] 百度AI服务测试通过

### 部署后验证
- [ ] 服务正常启动
- [ ] Web界面可访问
- [ ] 登录功能正常
- [ ] 文章发布功能正常
- [ ] AI审核功能正常
- [ ] 统计功能正常

### 安全检查
- [ ] 默认密码已修改
- [ ] 防火墙已配置
- [ ] SSL证书已安装
- [ ] 日志记录正常
- [ ] 备份策略已制定

## 🆘 常见问题解决

### 1. Python版本问题
```bash
# 如果系统Python版本过低，安装新版本
sudo apt update
sudo apt install python3.9 python3.9-pip python3.9-venv

# 创建虚拟环境
python3.9 -m venv venv
source venv/bin/activate
```

### 2. 依赖安装失败
```bash
# 升级pip
pip install --upgrade pip

# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 3. 端口占用问题
```bash
# 查看端口占用
netstat -tlnp | grep 8001

# 杀死占用进程
sudo kill -9 <PID>
```

### 4. 权限问题
```bash
# 设置正确的文件权限
chmod +x start_v2_4.py
chown -R www-data:www-data /path/to/app
```

## 🎯 生产环境最佳实践

1. **使用虚拟环境**: 避免依赖冲突
2. **配置反向代理**: 提高安全性和性能
3. **启用SSL**: 保护数据传输安全
4. **定期备份**: 保护重要数据
5. **监控日志**: 及时发现问题
6. **自动重启**: 确保服务稳定性
7. **负载均衡**: 处理高并发访问
8. **定期更新**: 保持系统安全

## 📞 技术支持

如果在部署过程中遇到问题，请检查：
1. Python版本是否符合要求
2. 所有依赖是否正确安装
3. 环境变量是否正确配置
4. 网络连接是否正常
5. 日志文件中的错误信息

部署成功后，您的WordPress软文发布系统就可以在生产环境中稳定运行了！